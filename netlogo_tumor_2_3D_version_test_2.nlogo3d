turtles-own
[
  stem?     ;; true for stem cells, false for transitory cells
  age  ;; age of cell. changes color with age
  metastatic?  ;; false for progeny of stem cell 0, true for progeny of stem cell 1
  EGFR
  RAS             ; 0 si désactivée, 1 si activée
  RAF             ; 0 si désactivée, 1 si activée
  
]

patches-own
[
  GEF         ;;growth factor
  GAP         ;;growth factor
  other_growth_factors      ;;growth factor
]

globals
[
  cell-count
]

to setup
  clear-all
  ;;set-default-shape turtles "ball "
  ;;ask patches
    ;;[ set pcolor black + 1 ]
  set-stem
  ;;set-gradients
  evaluate-params
  reset-ticks
end

to set-stem   ;;create two stem cells
  create-turtles 2
  [
    set size 2   ; easier to see
    setxyz (min-pxcor / 3) (min-pycor / 3) (min-pzcor / 3)   ;; placement pour que les cellules filles ne sortent pas du cube
    set stem? true
    set metastatic? false
    set color blue
    set age 0
    set RAS false
  ]
  ask turtle 1
  [
    set metastatic? true
    facexyz 270 270 270            ;; stem cell 1 will move away
  ]
  set cell-count 2
end

;;to set-gradients
 ;; ask patches
    ;;[ set H+ 0
   ;;   set O2 20
    ;;]
;;end

to go
  ask turtles
  [
    if (who = 1) and (xcor < max-pxcor - 12)
    [ fd 0.1 ]  ;stem cell movement
    set age age + 1
    move-transitional-cells
    if (patch.GEF) and (count turtles-here >= 0)
      [ activate_RAS ]
    if (patch.GAP) and (count turtles-here >= 0)
      [ deactivate_RAS ]
    mitosis
    death
  ]

  ;;consommation

  tick
  evaluate-params

end

;;transitional cells move and hatch more. Turtle proc.
to move-transitional-cells
  if (not stem?)
  [
    set color ( red + 0.25 * age )
    fd 1
    if (age < 6)
    [
      hatch 1
      [  ;amplification
        facexyz random-float 360 random-float 360 random-float 360
        fd 0.5
      ;kill-wrapped
       ]
    ]
  ]
end

to mitosis ;; turtle proc. - stem cells only
  if (stem?) and (RAS)
  [
    hatch 1
    [
      fd 0.3
      set color red
      set stem? false
      ifelse (who = 1)
        [ set age 16 ]
        [ set age 0 ]
    ]
  ]

  if (not stem?) and (distancexyz (min-pxcor / 3) (min-pycor / 3) (min-pzcor / 3) < 0.8) and (RAS)                                 ;; division des cellules autres que souches proches des cellules souches
  [
    hatch 1
    [
      fd 0.3
      set color red
      set stem? false
      ifelse (who = 1)
        [ set age 16 ]
        [ set age 0 ]
    ]
  ]
end

to death   ;; turtle proc.
  if (not stem?) and (not metastatic?) and (age > 20)
    [ die ]
  if (not stem?) and (metastatic?) and (age > 4)
    [ die ]
end

to evaluate-params
  set cell-count count turtles  ;cell count
  if (cell-count <= 0)
    [ stop ]
end

to kill-original-stem-cell
  ask turtle 0
    [ die ]
end

to kill-moving-stem-cell
  ask turtle 1
    [ die ]
end

to kill-transitory-cells
  ask turtles with [ age < 10 and not stem? ]
    [ die ]
end

;;to consommation
 ;; ask patches with [(O2 > 0) and (H+ < 20)]
 ;;   [
    ;;  set O2 O2 - (count turtles-here) / 2
    ;;  set H+ H+ + (count turtles-here) / 2
  ;;  ]
;;end


to activate_RAS
  ask turtles with [ RAS = false ]
  [ set RAS true ]
end

to deactivate_RAS
   ask turtles with [ RAS = true ]
  [ set RAS false ]
end




;;;;;;;;;;partie commentaire;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; mettre des cirseurs pour chaque protéine ou composant ayant une influence majeur dans le comportement de le tumeur
;ajouter un bouton chimio qui tue quasi toutes les cellules sauf les souches et mettre une proba très faible pour que les souches relancent une tumeur(rand entre 0 et 1 et que si le nombre est <0.000000000001 par exemple)


